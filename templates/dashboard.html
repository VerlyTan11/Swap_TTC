{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Dashboard Pertukaran Jadwal</h3>

    {% if session.role == 'admin' %}
    <a href="{{ url_for('run_ttc') }}" class="btn btn-success">Jalankan Algoritma TTC & Lihat Hasil</a>
    {% else %}
    <a href="{{ url_for('results') }}" class="btn btn-info">Lihat Hasil Pertukaran</a>
    {% endif %}
</div>

<!-- [LOGIKA UTAMA] Tampilkan blok ini hanya untuk admin -->
{% if session.role == 'admin' %}
<hr>
<h4>Daftar Preferensi Mahasiswa Aktif</h4>

{% if all_preferences %}
<div class="accordion" id="prefsAccordion">
    {% for nim, data in all_preferences.items() %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ nim }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapse-{{ nim }}" aria-expanded="false" aria-controls="collapse-{{ nim }}">
                <strong>{{ data.name }} ({{ nim }})</strong> &nbsp;- Menawarkan:&nbsp; <span class="text-danger">{{
                    data.offered_course }}</span>
            </button>
        </h2>
        <div id="collapse-{{ nim }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ nim }}"
            data-bs-parent="#prefsAccordion">
            <div class="accordion-body">
                <h5>Menginginkan:</h5>
                <ul class="list-group">
                    {% for pref in data.preferred_courses %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ pref.urutan }}. <span class="text-success">{{ pref.target }}</span>
                        <span class="badge bg-primary rounded-pill">Skor: {{ pref.skor }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info mt-3">Belum ada mahasiswa yang memasukkan preferensi.</div>
{% endif %}

<!-- Tampilkan formulir ini hanya untuk mahasiswa -->
{% else %}
<form action="{{ url_for('save_preferences') }}" method="POST" id="preferenceForm">
    <div class="row">
        <div class="col-md-5">
            <h4>Jadwal Anda Saat Ini</h4>
            <p>Pilih satu kelas yang ingin Anda tukarkan.</p>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Pilih</th>
                        <th>Kode MK</th>
                        <th>Nama Mata Kuliah</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in schedule %}
                    <tr>
                        <td>
                            <input type="radio" name="enrollment_to_swap" value="{{ s.enrollment_id }}"
                                data-course-name="{{ s.course_name }} ({{ s.class_name }})" required>
                        </td>
                        <td>{{ s.course_code }}</td>
                        <td>{{ s.course_name }} ({{ s.class_name }})</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center">Anda tidak memiliki jadwal.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="col-md-7">
            <h4>Pilih Preferensi Kelas Tujuan</h4>
            <p>Centang kelas yang diinginkan. Urutan centang akan menentukan prioritas.</p>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Pilih</th>
                            <th>Nama Mata Kuliah</th>
                            <th>Jadwal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in all_classes %}
                        <tr>
                            <td><input type="checkbox" name="preferred_classes" value="{{ c.id }}"
                                    data-course-name="{{ c.course_name }} ({{ c.class_name }})"></td>
                            <td>{{ c.course_name }} ({{ c.class_name }})</td>
                            <td>{{ c.day }}, {{ c.start_time }} - {{ c.end_time }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bagian Preview -->
    <hr>
    <div class="row justify-content-center mt-3">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4>Preview Pertukaran</h4>
                </div>
                <div class="card-body">
                    <p>Anda akan menukar kelas:</p>
                    <h5 class="text-danger" id="offer-preview">-- Belum dipilih --</h5>
                    <hr>
                    <p>Dengan urutan preferensi:</p>
                    <ol id="prefs-preview">
                        <li id="no-prefs-msg">-- Belum ada preferensi yang dipilih --</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" name="preferred_classes_ordered" id="preferred_classes_ordered">

    <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary btn-lg">Simpan Preferensi</button>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const offerRadios = document.querySelectorAll('input[name="enrollment_to_swap"]');
        const prefCheckboxes = document.querySelectorAll('input[name="preferred_classes"]');
        const offerPreview = document.getElementById('offer-preview');
        const prefsPreview = document.getElementById('prefs-preview');
        const noPrefsMsg = document.getElementById('no-prefs-msg');
        const hiddenInput = document.getElementById('preferred_classes_ordered');
        const form = document.getElementById('preferenceForm');

        let preferredOrder = [];

        function updatePreview() {
            const selectedRadio = document.querySelector('input[name="enrollment_to_swap"]:checked');
            offerPreview.textContent = selectedRadio ? selectedRadio.dataset.courseName : '-- Belum dipilih --';
            prefsPreview.innerHTML = '';
            if (preferredOrder.length > 0) {
                preferredOrder.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="text-success">${item.name}</span> <span class="badge bg-secondary">${index === 0 ? 'Skor: 100' : (index === 1 ? 'Skor: 50' : 'Skor: 25')}</span>`;
                    prefsPreview.appendChild(li);
                });
            } else {
                prefsPreview.innerHTML = '<li id="no-prefs-msg">-- Belum ada preferensi yang dipilih --</li>';
            }
        }

        offerRadios.forEach(radio => radio.addEventListener('change', updatePreview));
        prefCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const classId = this.value;
                const className = this.dataset.courseName;
                if (this.checked) {
                    preferredOrder.push({ id: classId, name: className });
                } else {
                    preferredOrder = preferredOrder.filter(item => item.id !== classId);
                }
                updatePreview();
            });
        });

        form.addEventListener('submit', function (e) {
            const orderedIds = preferredOrder.map(item => item.id);
            hiddenInput.value = orderedIds.join(',');
        });

        updatePreview();
    });
</script>
{% endif %}
{% endblock %}