{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Dashboard Pertukaran Jadwal</h3>

    {% if session.role == 'admin' %}
    <a href="{{ url_for('run_ttc') }}" class="btn btn-success">Jalankan Algoritma TTC & Lihat Hasil</a>
    {% else %}
    <a href="{{ url_for('results') }}" class="btn btn-info">Lihat Hasil Pertukaran</a>
    {% endif %}
</div>

{% if session.role == 'admin' %}
<hr>
<h4>Daftar Preferensi Mahasiswa Aktif</h4>

{% if all_preferences %}
<div class="accordion" id="prefsAccordion">
    {% for nim, data in all_preferences.items() %}
    <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ nim }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapse-{{ nim }}" aria-expanded="false" aria-controls="collapse-{{ nim }}">
                <strong>{{ data.name }} ({{ nim }})</strong> &nbsp;- Menawarkan:&nbsp; <span class="text-danger">{{
                    data.offered_course }}</span>
            </button>
        </h2>
        <div id="collapse-{{ nim }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ nim }}"
            data-bs-parent="#prefsAccordion">
            <div class="accordion-body">
                <h5>Menginginkan:</h5>
                <ul class="list-group">
                    {% for pref in data.preferred_courses %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ pref.urutan }}. <span class="text-success">{{ pref.target }}</span>
                        <span class="badge bg-primary rounded-pill">Skor: {{ pref.skor }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info mt-3">Belum ada mahasiswa yang memasukkan preferensi.</div>
{% endif %}

{% else %}
<form action="{{ url_for('save_preferences') }}" method="POST">
    <div class="row">
        <div class="col-md-6">
            <h4>Jadwal Anda Saat Ini</h4>
            <p>Pilih satu kelas yang ingin Anda tukarkan.</p>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Pilih</th>
                        <th>Kode MK</th>
                        <th>Nama Mata Kuliah</th>
                        <th>Kelas</th>
                        <th>Hari & Waktu</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in schedule %}
                    <tr>
                        <td>
                            <input type="radio" name="enrollment_to_swap" value="{{ s.enrollment_id }}" required>
                        </td>
                        <td>{{ s.course_code }}</td>
                        <td>{{ s.course_name }}</td>
                        <td>{{ s.class_name }}</td>
                        <td>{{ s.day }}, {{ s.start_time }} - {{ s.end_time }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center">Anda tidak memiliki jadwal.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="col-md-6">
            <h4>Pilih Preferensi Kelas Tujuan</h4>
            <p>Centang kelas yang Anda inginkan sebagai pengganti. Urutan centang akan menentukan prioritas.</p>
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Pilih</th>
                            <th>Kode MK</th>
                            <th>Nama Mata Kuliah</th>
                            <th>Kelas</th>
                            <th>Jadwal</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for c in all_classes %}
                        <tr>
                            <td><input type="checkbox" name="preferred_classes" value="{{ c.id }}"></td>
                            <td>{{ c.course_code }}</td>
                            <td>{{ c.course_name }}</td>
                            <td>{{ c.class_name }}</td>
                            <td>{{ c.day }}, {{ c.start_time }} - {{ c.end_time }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="text-center mt-3">
        <button type="submit" class="btn btn-primary btn-lg">Simpan Preferensi</button>
    </div>
</form>
{% endif %}
{% endblock %}