{% extends "base.html" %}
{% block title %}Hasil Pertukaran{% endblock %}

{% block content %}

<!-- [PERUBAHAN BARU] Tombol Pemicu Modal dan Ekspor -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Hasil Pertukaran Jadwal</h3>
    {% if session.role == 'admin' %}
    <div>
        <!-- Tombol Pemicu Modal Statistik -->
        {% if stats %}
        <button type.="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#statsModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-clipboard-data" viewBox="0 0 16 16">
                <path
                    d="M4 11a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0v-1zm6-4a1 1 0 1 1 2 0v5a1 1 0 1 1-2 0V7zM7 9a1 1 0 1 1 2 0v3a1 1 0 1 1-2 0V9z" />
                <path
                    d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z" />
                <path
                    d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z" />
            </svg>
            Lihat Laporan Statistik
        </button>
        {% endif %}

        <!-- Tombol Ekspor Excel -->
        <a href="{{ url_for('export_report_excel') }}" class="btn btn-outline-success">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download"
                viewBox="0 0 16 16">
                <path
                    d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                <path
                    d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
            </svg>
            Ekspor Excel
        </a>
    </div>
    {% endif %}
</div>
<hr>

<!-- [PERUBAHAN BARU] Tampilan Statistik Rata-rata yang Lebih Baik -->
{% if session.role == 'admin' %}
<div class="row">
    <div class="col-md-12">
        <h4>Ringkasan Eksekusi</h4>
        <div class="card text-white bg-info mb-3">
            <div class="card-header">Statistik Kepuasan Umum</div>
            <div class="card-body">
                <h3 class="card-title">{{ "%.2f"|format(average_satisfaction) }}%</h3>
                <p class="card-text">Rata-rata persentase kepuasan mahasiswa yang berhasil bertukar.</p>
            </div>
        </div>
    </div>
</div>
{% elif successful_swaps %}
<h4>Status Pertukaran Anda</h4>
<div class="alert alert-success">
    Selamat, Anda berhasil bertukar jadwal dengan skor preferensi: <strong>{{ average_satisfaction }}%</strong>
</div>
{% endif %}


<h4>
    {% if session.role == 'admin' %}
    Mahasiswa yang Berhasil Bertukar
    {% else %}
    Detail Pertukaran Anda
    {% endif %}
</h4>

{% if successful_swaps %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>NIM</th>
                <th>Kelas Lama</th>
                <th>Kelas Baru</th>
                <th>Skor Preferensi</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% for swap in successful_swaps %}
            <tr>
                <td>{{ swap.nim }}</td>
                <td>{{ swap.before_course }} ({{ swap.before_class }})</td>
                <td>{{ swap.after_course }} ({{ swap.after_class }})</td>
                <td>{{ swap.score_points }}%</td>
                <td>
                    <a href="{{ url_for('details', nim=swap.nim) }}" class="btn btn-sm btn-info">Detail</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
{% if session.role == 'admin' %}
<div class="alert alert-warning">Tidak ada mahasiswa yang berhasil bertukar pada proses ini.</div>
{% elif unsuccessful_swaps %}
<div class="alert alert-warning">Anda berpartisipasi dalam pertukaran, namun sistem tidak menemukan pasangan yang cocok
    untuk preferensi Anda.</div>
{% else %}
<div class="alert alert-info">Anda tidak berpartisipasi dalam pertukaran jadwal, atau hasil belum tersedia.</div>
{% endif %}
{% endif %}

{% if session.role == 'admin' %}
<h4 class="mt-5">Mahasiswa yang Berpartisipasi Namun Tidak Berhasil</h4>
{% if unsuccessful_swaps %}
<div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
    <table class="table table-sm table-bordered">
        <tbody>
            {% for student in unsuccessful_swaps %}
            <tr>
                <td>{{ student.nim }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-success">Semua partisipan berhasil menemukan pertukaran.</div>
{% endif %}
{% endif %}


<!-- [PERUBAHAN BARU] Modal Statistik -->
{% if session.role == 'admin' and stats %}
<div class="modal fade" id="statsModal" tabindex="-1" aria-labelledby="statsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="statsModalLabel">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                        class="bi bi-clipboard-data-fill" viewBox="0 0 16 16">
                        <path
                            d="M6.5 0A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3Zm3 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3Z" />
                        <path
                            d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1A2.5 2.5 0 0 1 9.5 5h-3A2.5 2.5 0 0 1 4 2.5v-1ZM7 11a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0v-1Zm-3 0a1 1 0 1 1 2 0v1a1 1 0 1 1-2 0v-1Zm6-4a1 1 0 1 1 2 0v5a1 1 0 1 1-2 0V7Z" />
                    </svg>
                    Laporan Statistik Eksekusi
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Total Mahasiswa Partisipasi
                        <span class="badge bg-primary rounded-pill fs-6">{{ stats.total_participants }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Total Kelas yang Diajukan (Request)
                        <span class="badge bg-secondary rounded-pill fs-6">{{ stats.total_requested_swaps }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Total Variasi Kelas Unik
                        <span class="badge bg-secondary rounded-pill fs-6">{{ stats.total_class_variations }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center text-success fw-bold">
                        Mahasiswa Berhasil Tukar (Minimal 1)
                        <span class="badge bg-success rounded-pill fs-6">{{ stats.successful_count }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center text-danger fw-bold">
                        Mahasiswa Gagal Total
                        <span class="badge bg-danger rounded-pill fs-6">{{ stats.unsuccessful_count }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center fw-bold">
                        Persentase Keberhasilan (per Mahasiswa)
                        <span class="badge bg-info text-dark rounded-pill fs-6">{{
                            "%.2f"|format(stats.success_percentage) }}%</span>
                    </li>
                </ul>

                <h6 class="mt-4">Laporan Performa</h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Waktu Komputasi Total
                        <span class="badge bg-light text-dark rounded-pill">{{ "%.4f"|format(stats.duration) }}
                            detik</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Memori yang Digunakan
                        <span class="badge bg-light text-dark rounded-pill">{{ "%.2f"|format(stats.mem_used_mb) }}
                            MB</span>
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}